{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "util-foundry.json",

	"title": "Util: Foundry",
	"version": "1.1.7",

	"$defs" : {
		"entryDataObject": {
			"description": "Additional \"5etools-type\" data to be stored on the entry.",
			"type": "object",
			"properties": {
				"languageProficiencies": {
					"$ref": "util.json#/$defs/languageProficiencies"
				},
				"skillProficiencies": {
					"$ref": "util.json#/$defs/skillProficiencies"
				},
				"weaponProficiencies": {
					"$ref": "util.json#/$defs/weaponProficiencies"
				},
				"armorProficiencies": {
					"$ref": "util.json#/$defs/armorProficiencies"
				},
				"toolProficiencies": {
					"$ref": "util.json#/$defs/toolProficiencies"
				},
				"savingThrowProficiencies": {
					"$ref": "util.json#/$defs/savingThrowProficiencies"
				},
				"skillToolLanguageProficiencies": {
					"$ref": "util.json#/$defs/skillToolLanguageProficiencies"
				},
				"expertise": {
					"$ref": "util.json#/$defs/expertise"
				},
				"resist": {
					"$ref": "util.json#/$defs/damageResistArrayPlayer"
				},
				"immune": {
					"$ref": "util.json#/$defs/damageImmunityArrayPlayer"
				},
				"vulnerable": {
					"$ref": "util.json#/$defs/damageVulnerabilityArrayPlayer"
				},
				"conditionImmune": {
					"$ref": "util.json#/$defs/conditionImmunityArrayPlayer"
				},
				"resources": {
					"$ref": "util.json#/$defs/resourcesArray"
				},
				"senses": {
					"$ref": "util.json#/$defs/sensesArray"
				},
				"additionalSpells": {
					"$ref": "util-additionalspells.json#/$defs/additionalSpellsArray"
				}
			},
			"additionalProperties": false
		},

		"foundryId": {
			"type": "string",
			"minLength": 16,
			"maxLength": 16,
			"pattern": "^[A-Za-z0-9]+$"
		},

		"foundryIdShort": {
			"type": "string",
			"minLength": 1,
			"maxLength": 16,
			"pattern": "^[A-Za-z0-9]+$"
		},

		"foundryTokenScale": {
			"type": "number",
			"minimum": 0.2,
			"maximum": 3,
			"multipleOf" : 0.1
		},

		"foundryTokenSubjectScale": {
			"type": "number",
			"minimum": 0.8,
			"maximum": 3,
			"multipleOf" : 0.1
		},

		"foundryIdentifier": {
			"type": "string",
			"pattern": "^[-A-Za-z0-9]+$"
		},

		"foundrySystemObject": {
			"type": "object"
		},

		"foundryFlagsObject": {
			"type": "object"
		},

		"foundryAdvancementObject": {
			"type": "object"
		},

		"foundryAdvancementsArray": {
			"type": "array",
			"minItems": 1,
			"items": {"$ref": "#/$defs/foundryAdvancementObject"},
			"uniqueItems": true
		},

		"foundryPrototypeTokenObject": {
			"type": "object"
		},

		"foundryImg": {
			"type": "string"
		},

		"_foundrySkill": {
			"type": "string",
			"enum": [
				"acr",
				"ani",
				"arc",
				"ath",
				"dec",
				"his",
				"ins",
				"itm",
				"inv",
				"med",
				"nat",
				"prc",
				"prf",
				"per",
				"rel",
				"slt",
				"ste",
				"sur"
			]
		},

		"_foundryTool": {
			"type": "string",
			"enum": [
				"alchemist",
				"bagpipes",
				"brewer",
				"calligrapher",
				"card",
				"carpenter",
				"cartographer",
				"chess",
				"cobbler",
				"cook",
				"dice",
				"disg",
				"drum",
				"dulcimer",
				"flute",
				"forg",
				"glassblower",
				"herb",
				"horn",
				"jeweler",
				"leatherworker",
				"lute",
				"lyre",
				"mason",
				"navg",
				"painter",
				"panflute",
				"pois",
				"potter",
				"shawm",
				"smith",
				"thief",
				"tinker",
				"viol",
				"weaver",
				"woodcarver"
			]		},

		"_foundryIdRef": {
			"type": "object",
			"properties": {
				"foundryId": {"$ref": "#/$defs/foundryIdShort"}
			},
			"required": ["foundryId"]
		},

		"foundrySubEntitiesObject": {
			"description": "A 5etools-data-like object of additional entities to import.",
			"type": "object",
			"properties": {
				"item": {"$ref": "items.json#/$defs/subEntityItemArray"}
			},
			"minProperties": 1
		},

		"_foundryActivityProfileBase": {
			"type": "object",
			"properties": {
				"name": {"type": "string"},
				"types": {
					"type": "array",
					"items": {
						"type": "string"
					},
					"minItems": 1,
					"uniqueItems": true
				},
				"movement": {"type": "array", "items": {"type": "string"}, "minItems": 1, "uniqueItems": true},
				"sizes": {"type": "array", "items": {"type": "string"}, "minItems": 1, "uniqueItems": true},
				"count": {"type": ["integer", "string"]},
				"level": {
					"type": "object",
					"properties": {
						"min": {"type": "integer"},
						"max": {"type": "integer"}
					}
				}
			}
		},

		"_foundryActivityProfile": {
			"anyOf": [
				{
					"$$merge": [
						{"$ref": "#/$defs/_foundryActivityProfileBase"},
						{
							"type": "object",
							"additionalProperties": false,
							"unevaluatedProperties": {
								"not": {
									"anyOf": [
										{"required": ["cr"]},
										{"required": ["uuid"]}
									]
								}
							}
						}
					]
				},
				{
					"$$merge": [
						{"$ref": "#/$defs/_foundryActivityProfileBase"},
						{
							"type": "object",
							"properties": {
								"cr": {"type": "string"}
							},
							"additionalProperties": false,
							"required": ["cr"]
						}
					]
				},
				{
					"$$merge": [
						{"$ref": "#/$defs/_foundryActivityProfileBase"},
						{
							"type": "object",
							"properties": {
								"uuid": {
									"type": "string",
									"pattern": "^@creature\\[.*\\]$"
								}
							},
							"additionalProperties": false,
							"required": ["uuid"]
						}
					]
				}
			]
		},

		"_foundryActivityProfiles": {
			"type": "array",
			"items": {"$ref": "#/$defs/_foundryActivityProfile"}
		},

		"_foundryActivityObject_base": {
			"type": "object",
			"properties": {
				"foundryId": {
					"description": "Use only when required. For example, when linking a \"rider\".",
					"$ref": "#/$defs/foundryIdShort"
				},

				"img": {"type": "string"},
				"description": {"type": "object"},
				"descriptionEntries": {
					"description": "If supplied, will be used to populate \"description.chatFlavor\".",
					"type": "array",
					"items": {"$ref": "entry.json"}
				},

				"consumption": {
					"type": "object",
					"properties": {
						"targets": {
							"type": "array",
							"items": {
								"type": "object",
								"properties": {
									"target": {
										"oneOf": [
											{"type": "string"},
											{
												"description": "A link to an importable entity",
												"type": "object",
												"properties": {
													"prop": {"type": "string"},
													"uid": {"type": "string"}
												},
												"required": ["prop", "uid"],
												"additionalProperties": false
											},
											{
												"description": "A link to a 5etools-style resource",
												"type": "object",
												"properties": {
													"consumes": {
														"type": "object",
														"properties": {
															"name": {"$ref": "util.json#/$defs/consumesName"}
														},
														"required": ["name"],
														"additionalProperties": false
													}
												},
												"required": ["consumes"],
												"additionalProperties": false
											}
										]
									}
								}
							}
						}
					}
				},

				"effects": {
					"type": "array",
					"items": {"$ref": "#/$defs/_foundryIdRef"}
				},

				"_id": false,
				"sort": false,

				"template": false,
				"affects": false
			},
			"required": ["type"]
		},

		"_foundryActivityObject_attack": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "attack"}
					}
				}
			]
		},

		"_foundryActivityObject_damage": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "damage"}
					}
				}
			]
		},

		"_foundryActivityObject_save": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "save"}
					}
				}
			]
		},

		"_foundryActivityObject_check": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "check"},

						"check": {
							"type": "object",
							"properties": {
								"associated": {
									"type": "array",
									"items": {
										"oneOf": [
											{"$ref": "#/$defs/_foundrySkill"},
											{"$ref": "#/$defs/_foundryTool"}
										]
									}
								},

								"ability": {"$ref": "util.json#/$defs/abilityScoreAbbreviation"}
							}
						}
					}
				}
			]
		},

		"_foundryActivityObject_heal": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "heal"}
					}
				}
			]
		},

		"_foundryActivityObject_cast": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "cast"},

						"spell": {
							"type": "object",
							"properties": {
								"uuid": {"type": "string"}
							}
						}
					}
				}
			]
		},

		"_foundryActivityObject_enchant": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "enchant"},

						"effects": {
							"type": "array",
							"items": {
								"$$merge": [
									{"$ref": "#/$defs/_foundryIdRef"},
									{
										"type": "object",
										"properties": {
											"riders": {
												"type": "object",
												"properties": {
													"activity": {
														"type": "array",
														"items": {"$ref": "#/$defs/_foundryIdRef"}
													},
													"effect": {
														"type": "array",
														"items": {"$ref": "#/$defs/_foundryIdRef"}
													}
												},
												"minProperties": 1
											}
										}
									}
								]
							}
						},

						"enchant": {
							"type": "object",
							"properties": {
								"self": {"const": true}
							}
						}
					}
				}
			]
		},

		"_foundryActivityObject_summon": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "summon"},
						"profiles": {"$ref": "#/$defs/_foundryActivityProfiles"}
					}
				}
			]
		},

		"_foundryActivityObject_transform": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "transform"},
						"profiles": {"$ref": "#/$defs/_foundryActivityProfiles"},
						"transform": {
							"type": "object",
							"properties": {
								"customize": {"const": true}
							}
						}
					}
				}
			]
		},

		"_foundryActivityObject_utility": {
			"$$merge": [
				{"$ref": "#/$defs/_foundryActivityObject_base"},
				{
					"type": "object",
					"properties": {
						"type": {"const": "utility"}
					}
				}
			]
		},

		"foundryActivityObject": {
			"anyOf": [
				{"$ref": "#/$defs/_foundryActivityObject_attack"},
				{"$ref": "#/$defs/_foundryActivityObject_damage"},
				{"$ref": "#/$defs/_foundryActivityObject_save"},
				{"$ref": "#/$defs/_foundryActivityObject_check"},
				{"$ref": "#/$defs/_foundryActivityObject_heal"},
				{"$ref": "#/$defs/_foundryActivityObject_cast"},
				{"$ref": "#/$defs/_foundryActivityObject_summon"},
				{"$ref": "#/$defs/_foundryActivityObject_enchant"},
				{"$ref": "#/$defs/_foundryActivityObject_transform"},
				{"$ref": "#/$defs/_foundryActivityObject_utility"}
			]
		},

		"_foundryEffectObject": {
			"type": "object",
			"properties": {
				"foundryId": {
					"description": "Use only when required. For example, when linking an \"enchantmentRiderParent\".",
					"$ref": "#/$defs/foundryIdShort"
				},

				"name": {"type": "string"},
				"img": {"type": "string"},
				"description": {"type": "string"},
				"descriptionEntries": {
					"type": "array",
					"items": {"$ref": "entry.json"}
				},
				"changes": {
					"type": "array",
					"items": {
						"type": "object",
						"properties": {
							"key": {"type": "string"},
							"mode": {"type": ["string", "integer"]},
							"value": true,
							"priority": {"type": ["string", "integer"]}
						},
						"required": ["key", "mode", "value"],
						"additionalProperties": false
					}
				},
				"statuses": {
					"description": "Dumped via e.g. `copy(Object.keys(CONFIG.DND5E.conditionTypes).sort())`",
					"type": "array",
					"items": {
						"type": "string",
						"enum": [
							"bleeding",
							"blinded",
							"burning",
							"charmed",
							"cursed",
							"deafened",
							"dehydration",
							"diseased",
							"exhaustion",
							"falling",
							"frightened",
							"grappled",
							"incapacitated",
							"invisible",
							"malnutrition",
							"paralyzed",
							"petrified",
							"poisoned",
							"prone",
							"restrained",
							"silenced",
							"stunned",
							"suffocation",
							"surprised",
							"transformed",
							"unconscious",

							"coverHalf",
							"coverThreeQuarters",
							"dead",
							"dodging",
							"ethereal",
							"hiding",
							"marked",
							"stable",
							"flying"
						]
					}
				},
				"flags": {"type": "object"},
				"duration": {"type": "object"},
				"disabled": {"const": true},
				"transfer": {"const": true},

				"enchantmentLevelMin": {"type": "number", "minimum": 0, "maximum": 20},
				"enchantmentLevelMax": {"type": "number", "minimum": 0, "maximum": 20},
				"enchantmentRiderParent": {"$ref": "#/$defs/foundryIdShort"},
				"type": {
					"type": "string",
					"enum": ["enchantment"]
				}
			},
			"additionalProperties": false
		},

		"foundryEffectObject": {
			"anyOf": [
				{
					"allOf": [
						{"$ref": "#/$defs/_foundryEffectObject"},
						{"type": "object", "required": ["changes"]}
					]
				},
				{
					"allOf": [
						{"$ref": "#/$defs/_foundryEffectObject"},
						{"type": "object", "required": ["statuses"]}
					]
				},
				{
					"description": "An effect with no functional changes, but a name. Should only be used for effects which cannot be otherwise automated.",
					"allOf": [
						{"$ref": "#/$defs/_foundryEffectObject"},
						{"type": "object", "required": ["name"]}
					]
				},
				{
					"description": "An effect with no functional changes, but a duration. Should only be used for effects which cannot be otherwise automated.",
					"allOf": [
						{"$ref": "#/$defs/_foundryEffectObject"},
						{"type": "object", "required": ["duration"]}
					]
				},
				{
					"description": "An effect with no functional changes, but descriptive text. Should only be used for effects which cannot be otherwise automated.",
					"allOf": [
						{"$ref": "#/$defs/_foundryEffectObject"},
						{"type": "object", "required": ["description"]}
					]
				},
				{
					"description": "An effect with no functional changes, but descriptive text. Should only be used for effects which cannot be otherwise automated.",
					"allOf": [
						{"$ref": "#/$defs/_foundryEffectObject"},
						{"type": "object", "required": ["descriptionEntries"]}
					]
				},
				{
					"description": "An effect with no functional changes, but an enchantment link.",
					"allOf": [
						{"$ref": "#/$defs/_foundryEffectObject"},
						{
							"type": "object",
							"properties": {
								"type": {"const": "enchantment"}
							},
							"required": ["foundryId", "type"]
						}
					]
				}
			]
		},

		"foundryActivitiesArray": {
			"type": "array",
			"items": {"$ref": "#/$defs/foundryActivityObject"},
			"uniqueItems": true
		},

		"foundryEffectsArray": {
			"type": "array",
			"items": {"$ref": "#/$defs/foundryEffectObject"},
			"minItems": 1,
			"uniqueItems": true
		},

		"foundrySideDataGenericObject": {
			"type": "object",
			"properties": {
				"name": {"type": "string"},
				"source": {"$ref": "util.json#/$defs/source"},

				"identifier": {"$ref": "#/$defs/foundryIdentifier"},
				"system": {"$ref": "#/$defs/foundrySystemObject"},
				"activities": {"type": "array", "items": {"$ref": "#/$defs/foundryActivityObject"}},
				"effects": {"type": "array", "items": {"$ref": "#/$defs/foundryEffectObject"}},
				"flags": {"$ref": "#/$defs/foundryFlagsObject"},
				"advice": {"$ref": "entry.json"},
				"img": {"type": "string"},
				"advancement": {"$ref": "util-foundry.json#/$defs/foundryAdvancementsArray"},

				"migrationVersion": {"type": "integer"},

				"_merge": {"$ref": "#/$defs/foundryMergeObject"}
			},
			"required": [
				"name",
				"source"
			],
			"additionalProperties": false
		},

		"foundrySideDataGenericArray": {
			"type": "array",
			"minItems": 1,
			"uniqueItems": true,
			"items": {"$ref": "#/$defs/foundrySideDataGenericObject"}
		},

		"foundrySideDataGenericFeatureObject": {
			"$$merge": [
				{
					"$ref": "#/$defs/foundrySideDataGenericObject"
				},
				{
					"type": "object",
					"properties": {
						"entries": {"type": "array", "items": {"$ref": "entry.json"}},
						"isIgnored": {"const": true},
						"ignoreSrdActivities": {"const": true},
						"ignoreSrdEffects": {"const": true},

						"subEntities": {"$ref": "#/$defs/foundrySubEntitiesObject"}
					}
				}
			]
		},

		"foundrySideDataGenericFeatureArray": {
			"type": "array",
			"minItems": 1,
			"uniqueItems": true,
			"items": {"$ref": "#/$defs/foundrySideDataGenericFeatureObject"}
		},

		"foundrySideDataGenericActorObject": {
			"$$merge": [
				{
					"$ref": "#/$defs/foundrySideDataGenericObject"
				},
				{
					"type": "object",
					"properties": {
						"prototypeToken": {"$ref": "#/$defs/foundryPrototypeTokenObject"}
					}
				}
			]
		},

		"foundrySideDataGenericActorArray": {
			"type": "array",
			"minItems": 1,
			"uniqueItems": true,
			"items": {"$ref": "#/$defs/foundrySideDataGenericActorObject"}
		},

		"foundryMergeObject": {
			"description": "If our \"X\" (e.g. \"system\") should be merged with any base \"X\", rather than overwriting.",
			"type": "object",
			"properties": {
				"system": {"const": true},
				"chooseSystem": {"const": true},
				"effects": {"const": true},
				"flags": {"const": true},
				"chooseFlags": {"const": true},
				"activities": {"const": true}
			},
			"minProperties": 1
		}
	}
}
